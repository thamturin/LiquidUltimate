package net.ccbluex.liquidbounce.features.module.modules.exploit;

import net.ccbluex.liquidbounce.event.EventState;
import net.ccbluex.liquidbounce.event.EventTarget;
import net.ccbluex.liquidbounce.event.MotionEvent;
import net.ccbluex.liquidbounce.event.PacketEvent;
import net.ccbluex.liquidbounce.features.module.Module;
import net.ccbluex.liquidbounce.features.module.ModuleCategory;
import net.ccbluex.liquidbounce.features.module.ModuleInfo;
import net.minecraft.client.Minecraft;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S01PacketJoinGame;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;

import java.util.Queue;
import java.util.UUID;
import java.util.concurrent.ConcurrentLinkedDeque;

@ModuleInfo(name = "Disabler", description = "Make anti-cheats stop working.", category = ModuleCategory.EXPLOIT, canEnable = false)
public class Disabler extends Module {

    private final Queue<Packet<?>> packet = new ConcurrentLinkedDeque<>();
    private final Timer timer = new Timer();
    private boolean teleported;

    @EventTarget
    private void onMotion(MotionEvent event) {
        if (event.getEventState() == EventState.PRE) {
            if (timer.isDelayComplete(490L)) {
                timer.reset();

                if (!packet.isEmpty()) {
                    Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket(packet.poll(), null);
                }
            }
        }
    }

    @EventTarget
    private void onPacket(PacketEvent event) {
        if (event.getPacket() instanceof C0BPacketEntityAction) {
            final C0BPacketEntityAction c0B = (C0BPacketEntityAction) event.getPacket();

            if (c0B.getAction().equals(C0BPacketEntityAction.Action.START_SPRINTING)) {
                Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket
                        (new C0BPacketEntityAction(Minecraft.getMinecraft().thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING), null);
                event.cancelEvent();
            }

            if (c0B.getAction().equals(C0BPacketEntityAction.Action.STOP_SPRINTING)) {
                event.cancelEvent();
            }
        }

        if (event.getPacket() instanceof C00PacketKeepAlive || event.getPacket() instanceof C0FPacketConfirmTransaction) {
            packet.add(event.getPacket());
            event.cancelEvent();

            if (packet.size() > 300) {
                Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket
                        (packet.poll(), null);
            }
        }

        if (event.getPacket() instanceof C03PacketPlayer) {
            final C03PacketPlayer c03 = (C03PacketPlayer) event.getPacket();

            if (Minecraft.getMinecraft().thePlayer.ticksExisted % 20 == 0) {
                Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket
                        (new C18PacketSpectate(UUID.randomUUID()), null);
                Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket
                        (new C0CPacketInput(0.98F, 0.98F, false, false), null);
            }

            if (Minecraft.getMinecraft().thePlayer.ticksExisted % 120 == 0) {
                Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket
                        (new C03PacketPlayer.C04PacketPlayerPosition(c03.getPositionX(), -0.015625, c03.getPositionZ(), false), null);
                event.cancelEvent();
                teleported = true;
            }
        }
        if (event.getPacket() instanceof S01PacketJoinGame || Minecraft.getMinecraft().thePlayer.ticksExisted < 60) {
            packet.clear();
            teleported = false;
            return;
        }


        if (event.getPacket() instanceof S08PacketPlayerPosLook && teleported) {
            final S08PacketPlayerPosLook packet = (S08PacketPlayerPosLook) event.getPacket();

            Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket
                    (new C03PacketPlayer.C06PacketPlayerPosLook(packet.getX(), packet.getY(), packet.getZ(), packet.getYaw(), packet.getPitch(), true), null);
            event.cancelEvent();
            teleported = false;
        }

    }

}

class Timer {
    public long lastMs;

    public Timer() {
        this.lastMs = 0L;
    }

    public boolean isDelayComplete(final long delay) {
        return System.currentTimeMillis() - this.lastMs >= delay;
    }

    public boolean delay(float nextDelay, boolean reset) {
        if (System.currentTimeMillis() - lastMs >= nextDelay) {
            if (reset) {
                this.reset();
            }
            return true;
        }
        return false;
    }

    public long getCurrentMS() {
        return System.nanoTime() / 1000000L;
    }

    public void reset() {
        this.lastMs = System.currentTimeMillis();
    }

    public long getLastMs() {
        return this.lastMs;
    }

    public void setLastMs(final int i) {
        this.lastMs = System.currentTimeMillis() + i;
    }

    public boolean hasReached(final long milliseconds) {
        return this.getCurrentMS() - this.lastMs >= milliseconds;
    }

    public boolean isDelayComplete(float delay) {
        return System.currentTimeMillis() - this.lastMs > delay;
    }

    public boolean isDelayComplete(Double delay) {
        return System.currentTimeMillis() - this.lastMs > delay;
    }
}